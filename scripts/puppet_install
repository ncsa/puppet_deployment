#!/bin/bash

BASEPATH=/root/puppet_deployment
INCLUDES=( \
    $BASEPATH/common_funcs.sh
)

for f in "${INCLUDES[@]}"; do
    [[ -f "$f" ]] || { echo "Cant include file '$f'"; exit 1
    }
    source  "$f"
done

# Global variables (in all caps) are set once here and never changed
PUPPET=/opt/puppetlabs/bin/puppet
PUPPETSRVR=/opt/puppetlabs/bin/puppetserver
HOSTNAME=$(hostname)
DNS_ALT_NAMES=$( hostname -I | awk '{print $1}' )
REQUIRED_PKGS_COMMON=( bind-utils lsof )
REQUIRED_PKGS_MASTER=( PyYAML )
REQUIRED_PKGS_AGENT=()

# Command line options (defaults)
VERBOSE=0
DEBUG=0
REPO_URL=https://yum.puppetlabs.com/puppetlabs-release-pc1-el-7.noarch.rpm
BKUP_DIR=/backups
BUILD_TYPE="$PUPBUILDTYPE"           #master | agent (allow to be set by env var)
CONFIG_TYPE="$PUPCONFIGTYPE"         #new | restore | r10k (allow env var)
AGENT_CERT_NAME="$PUPCERTNAME"       #allow override hostname


process_cmdline() {
while :; do
    case "$1" in
        -h|-\?|--help)
            echo "Usage: ${0##*/} [OPTIONS]"
            echo "Options:"
            echo "    -a                    (build an agent)"
            echo "    -A <AgentCertname>    (override certname, defaults to hostname)"
            echo "    -d                    (enable debug mode)"
            echo "    -m                    (build a master)"
            echo "    -M <new|restore|r10k> (how to configure puppet master)"
            echo "    -v                    (enable verbose mode)"
            exit
            ;;
        -a)
            BUILD_TYPE=agent
            ;;
        -A)
            AGENT_CERT_NAME="$2"
            shift
            ;;
        -d)
            VERBOSE=1
            DEBUG=1
            ;;
        -m)
            BUILD_TYPE=master
            ;;
        -M)
            CONFIG_TYPE="$2"
            shift
            ;;
        -v)
            VERBOSE=1
            ;;
        --)
            shift
            break
            ;;
        -?*)
            die "Invalid option: -$1"
            ;;
        *)
            break
            ;;
    esac
    shift
done

# assert valid build_type
case "$BUILD_TYPE" in
    master)
        # check config_type ... only relevant if build_type is MASTER
        if [[ " new restore r10k " =~ " $CONFIG_TYPE " ]]; then
        else
            die "Missing or invalid config type: '$CONFIG_TYPE' for puppet master"
        fi
        ;;
    agent)
        : #pass
        ;;
    *)
        die "Invalid build type '$BUILD_TYPE'"
        ;;
esac
}




###
# Functions
###





# Global variables that are set or modified by functions below
build_type=



continue_or_exit() {
    [[ -n "$1" ]] && echo "$1"
    shift
    local pause=60
    [[ -n "${1//[^0-9]/}" ]] && pause="${1//[^0-9]/}"
    echo "Continue?"
    local yn
    select yn in "Yes" "No"; do
        case $yn in
            Yes) return 0;;
            No ) exit 1;;
        esac
    done
}


assert_root() {
    log "enter..."
    [[ $EUID -eq 0 ]] || die 'Must be root'
}






install_required_pkgs() {
    log "enter..."
    local pkg_list=( "${REQUIRED_PKGS_COMMON[@]}" )
    case "$BUILD_TYPE" in
        master)
            pkg_list+=( "${REQUIRED_PKGS_MASTER[@]}" )
            ;;
        agent)
            pkg_list+=( "${REQUIRED_PKGS_AGENT[@]}" )
            ;;
    esac
    [[ ${#pkg_list[@]} -gt 0 ]] || die "empty pkg list"
    yum install -y "${pkg_list[@]}" || die "yum install returned non-zero"
}


puppet_install() {
    log "enter..."
    ls /etc/yum.repos.d/puppetlabs*.repo &>/dev/null \
    || yum -y install $REPO_URL

    local pkglist
    case "$BUILD_TYPE" in
        master)
            pkglist=( puppetserver )
            ;;
        agent)
            pkglist=( puppet-agent )
            ;;
    esac
    yum -y install "${pkglist[@]}"
}


get_bkup_src() {
    ls -t $BKUP_DIR/*_puppet_config.tar.gz | head -1
}


restore_config() {
    log "enter..."
    case "$BUILD_TYPE" in
        master)
            fn=$( get_bkup_src )
            [[ -z "$fn" ]] && die "Cant find a puppet backup"
            tar zxPf "$fn" --overwrite -T - <<ENDHERE
/etc/puppetlabs/puppet/*.conf
/etc/puppetlabs/puppet/*.yaml
/etc/puppetlabs/puppetserver/
/etc/puppetlabs/code/config/
ENDHERE
            ;;
        agent)
            log "nothing to do for build_type: '$BUILD_TYPE'"
            ;;
    esac
}


disable_puppetdb() {
    log "enter..."
    case "$BUILD_TYPE" in
        master)
            $PUPPET config set storeconfigs false --section master
            $PUPPET config set reports store --section master
            for f in puppetdb.conf routes.yaml; do
                rm /etc/puppetlabs/puppet/"$f"
            done
            ;;
        agent)
            log "nothing to do for build_type: '$BUILD_TYPE'"
            ;;
        *) die "unknown build type '$BUILD_TYPE'"
    esac
}


restore_environments() {
    log "enter..."
    fn=$( get_bkup_src )
    [[ -z "$fn" ]] && die "Cant find a puppet backup"
    find /etc/puppetlabs/code/environments -delete
    tar zxPf "$fn" --overwrite -T - <<ENDHERE
/etc/puppetlabs/code/environments
ENDHERE
}


restore_ca() {
    log "enter..."
    fn=$( get_bkup_src )
    [[ -z "$fn" ]] && die "Cant find a puppet backup"
    tar zxPf "$fn" --overwrite -T - <<ENDHERE
/etc/puppetlabs/puppet/ssl
ENDHERE
}


configure_ca() {
    log "enter..."
    case "$BUILD_TYPE" in
        master)
            [[ -d /etc/puppetlabs/puppet/ssl/ca ]] && {
                log 'CA already configured, skipping.'
                return 0
            }
            $PUPPET cert list -a
            $PUPPET config set certname $HOSTNAME --section master
            $PUPPET certificate generate \
                ${DNS_ALT_NAMES:+--dns-alt-names $DNS_ALT_NAMES} \
                --ca-location local \
                $HOSTNAME
            $PUPPET cert sign $HOSTNAME --allow-dns-alt-names
            # don't know what this does, but puppetserver won't start otherwise
            $PUPPET certificate find $HOSTNAME --ca-location local &>/dev/null
            ;;
        agent)
            log "nothing to do for build_type: '$BUILD_TYPE'"
            ;;
        *) die "unknown build type '$BUILD_TYPE'"
    esac
}


puppetserver() {
    log "enter..."
    [[ "$BUILD_TYPE" != 'master' ]] && {
        log "nothing to do for build_type: '$BUILD_TYPE'"
        return 0
    }
    #local pupsrvc="$PUPPET resource service puppetserver"
    local action=$1
    case $action in
        *start|reload) 
                #$pupsrvc ensure=running
                $PUPPETSRVR $action
                is_puppetserver_running || die 'puppetserver not running'
                ;;
        stop)
                #$pupsrvc ensure=stopped
                $PUPPETSRVR $action
                is_puppetserver_running && die 'puppetserver still running'
                ;;
        *)
                die "unknown action '$action'"
    esac
}


is_puppetserver_running() {
    log "enter..."
    lsof -i :8140 &>/dev/null
}


create_autosign() {
    log "enter..."
    fn=$( $PUPPET config print autosign )
    [[ -f $fn ]] && return 0
    cat > $fn <<ENDHERE
*.ncsa.illinois.edu
*.lsst.ncsa.edu
ENDHERE
}


agent_config() {
    log "enter..."
    case $BUILD_TYPE in
        master)
            log "nothing to do for build_type: '$BUILD_TYPE'"
            ;;
        agent)
            #set custom puppet server (if environment variable PUPMASTER exists)
            [[ -n "$PUPMASTER" ]] && $PUPPET config set server "$PUPMASTER"
            [[ -n "$PUPCERTNAME" ]] && $PUPPET config set certname "$PUPCERTNAME"
            ;;
        *)
            die "Unknown build_type '$BUILD_TYPE'"
    esac
}


agent_run() {
    log "enter..."
    case $BUILD_TYPE in
        master)
            log "nothing to do for build_type: '$BUILD_TYPE'"
            ;;
        agent)
            $PUPPET agent --test
            ;;
        *)
            die "Unknown build_type '$BUILD_TYPE'"
    esac
}


####################################################


assert_root
process_cmdline $*
install_required_pkgs
puppet_install

#restore_config
#disable_puppetdb
#restore_ca

#configure_ca
#puppetserver start
#agent_config
#agent_run
